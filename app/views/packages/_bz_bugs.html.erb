<%= render :partial => 'layouts/line' %>
<%= render :partial => 'layouts/sep' %>
<h3>Related Bugzilla Bugs</h3>


Link to an existing bug (Bugzilla Bug ID): <input id="input_bz_id"/>
<button onclick="createBzBugLink();">Link</button> <%= render :partial => 'layouts/progress_indicator', :locals => {:progress_indicator_id => 'bz_link_indicator'} %>
or
<button>Create a new bug</button>
in Bugzilla
<%= render :partial => 'layouts/sep' %>
Current linked bugs:
<%= render :partial => 'layouts/sep_tiny' %>
<div class='manage-tbl'>
  <table id='bz_list_tbl'>
    <tr>
      <th class='content-list-head'>Bug ID</th>
      <th class='content-list-head'>Operation</th>
    </tr>
    <% package.bz_bugs.each do |bz_bug| %>
        <tr>
          <td style='font-size:10px'>
            <%= link_to "bz#{bz_bug.bz_id}", "#{APP_CONFIG['bugzilla_prefix']}#{bz_bug.bz_id}", :target => '_blank' %>
          </td>
          <td style='font-size:10px'>
            Edit / <a href="javascript:void(0);" onclick="deleteBzBugLink('<%=bz_bug.id%>')">Delete</a>
          </td>
        </tr>
    <% end %>

  </table>
</div>
<%= render :partial => 'layouts/sep_tiny' %>

<% content_for :js do %>
    <script type="text/javascript">
        function createBzBugLink() {
            var bz_id = document.getElementById('input_bz_id').value;
            bz_id = bz_id.replace(/^\s+|\s+$/g, '');
            new Ajax.Request('/bz_bugs',
                    {
                        method: 'POST',
                        asynchronous: true,
                        evalScripts: true,
                        onLoading: function () {
                            Element.show('bz_link_indicator');
                        },
                        onSuccess: function (reply) {
                            Element.hide('bz_link_indicator');
                        },
                        parameters: {
                            'bz_id': bz_id,
                            'package_id': '<%=package.id%>',
                            'authenticity_token': '<%=form_authenticity_token%>'}
                    });
        }

        function addBugToTable(bz_id) {
            var tbl = document.getElementById('bz_list_tbl');
            var rowCnt = tbl.rows.length;
            var row = tbl.insertRow(rowCnt);
            var cell_1 = row.insertCell(0);
            cell_1.innerHTML = "<span class='small_font'><a target='_blank' href='<%=APP_CONFIG['bugzilla_prefix']%>" + bz_id + "'>" + bz_id + "</a></span>";
        }

        function deleteBzBugLink(id) {
            var confirm = window.confirm("Are you sure to remove link to bz" + id + "?");
            if (confirm == true) {
                new Ajax.Request('/bz_bugs/' + id,
                        {
                            method: 'POST',
                            asynchronous: true,
                            evalScripts: true,
                            onLoading: function () {
                                Element.show('bz_link_indicator');
                            },
                            onSuccess: function () {
                                Element.hide('bz_link_indicator');
                            },
                            parameters: {
                                '_method': 'delete',
                                'authenticity_token': '<%=form_authenticity_token%>'}
                        });
            }

        }

    </script>
    <%= render :partial => 'time_tracking_js' %>
<% end %>


<% content_for :css do %>
    <style type="text/css">
        .small_font {
            font-size: 10px;
        }
    </style>
<% end %>