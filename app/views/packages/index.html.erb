<% unless session[:cloned_packages].blank? %>
    Cloned Packages:
    <% session[:cloned_packages].each do |pack| %>
        <%= pack %> /
    <% end %>
    <% session[:cloned_packages] = nil %>
<% end %>
<%= render :partial => 'layouts/sep' %>
<% unless session[:not_cloned_packages].blank? %>
    Not Cloned Packages:
    <% session[:not_cloned_packages].keys.each do |key| %>
        <%= key %><%#session[:clone_reports][key]%> /
    <% end %>
    <% session[:not_cloned_packages] = nil %>
<% end %>


<% cache :action => 'index', :id => "#{params[:brew_tag_id]}#{params[:label]}#{params[:mark]}#{params[:user]}#{current_user_email}" do %>
    <% if has_tag? %>
        <% @brew_tag = BrewTag.find_by_name(unescape_url(params[:brew_tag_id])) %>
        <h2>
          Listing packages of <%= unescape_url(params[:brew_tag_id]) %>
          <% if has_label? %>
              / <%= unescape_url(params[:label]) %>
          <% end %>
          <% if has_mark? %>
              / <%= unescape_url(params[:mark]) %>
          <% end %>
        </h2>
        <% unless @brew_tag.description.blank? %>
            <%= @brew_tag.description %>
        <% end %>
    <% else %>
        <h2>Listing packages</h2>
    <% end %>

    <%= render :partial => 'ops' %>

    <%= render :partial => 'layouts/sep' %>

    Labels:
    <%= link_to "All (#{@all_packages_count})", :controller => :packages, :action => :index, :brew_tag_id => params[:brew_tag_id] %> /

    <% if logged_in? %>
        <%= link_to "My (#{@my_packages_count})", :controller => :packages, :action => :index, :brew_tag_id => params[:brew_tag_id], :user => session[:current_user].email %> /
    <% end %>

    <% Label.find_all_can_show_by_brew_tag_id_in_global_scope(BrewTag.find_by_name(unescape_url(params[:brew_tag_id])).id).each do |label| %>
        <%= link_to "#{label.name} (#{count_packages(unescape_url(params[:brew_tag_id]), label.name)})", :controller => :packages, :action => :index, :brew_tag_id => params[:brew_tag_id], :label => escape_url(label.name) %> /
    <% end %>
    <%= render :partial => 'layouts/sep' %>
    <% marks = BrewTag.find_by_name(unescape_url(params[:brew_tag_id])).marks %>
    <% unless marks.blank? %>
        Marks:
        <% marks.each do |mark| %>
            <%= link_to "#{mark.key} (#{mark.packages_can_show.size})", :controller => :packages, :action => :index, :brew_tag_id => params[:brew_tag_id], :mark => mark.key %> /
        <% end %>
    <% end %>

    <div class='manage-tbl'>
      <%= render :partial => 'layouts/sep' %>
      <table>
        <%= render :partial => 'packages/index/header', :locals => {:col => 'th'} %>
        <% @packages.each_with_index do |package, i| %>
            <% if i % 25 == 0 && i > 0 %>
                <%= render :partial => 'packages/index/header', :locals => {:col => 'td'} %>
            <% end %>
            <tr>
              <%= render :partial => 'packages/index/name', :locals => {:package => package} %>
              <%= render :partial => 'packages/index/label', :locals => {:package => package} %>
              <%= render :partial => 'packages/index/mark', :locals => {:package => package} %>
              <%= render :partial => 'packages/index/user', :locals => {:package => package} %>
              <%= render :partial => 'packages/index/xattr', :locals => {:package => package} %>
              <%= render :partial => 'packages/index/ops', :locals => {:package => package} %>
            </tr>
        <% end %>
      </table>
    </div>
<% end %>

<% content_for :js do %>
    <script type="text/javascript">
        function show_pac_editor(div) {
            Element.hide(div + '_field');
            Element.hide(div + '_btn');
            Element.show(div + '_editor');
            Element.setStyle(div + '_td', {'text-decoration':'none','background':'none'});
            document.getElementById(div + "_switch").innerHTML = 'off';
        }

        function show_pac_btn(div) {
            if (document.getElementById(div + "_switch").innerHTML == 'on')
                Element.show(div + '_btn');
        }

        function hide_pac_btn(div) {
            if (document.getElementById(div + "_switch").innerHTML == 'on')
                Element.hide(div + '_btn');
        }


        var pacBtns = document.getElementsByRegex('^pac.*btn');
//            alert('found ' + pacBtns.length + ' matches - expected 3.');

        Event.observe(window, 'load', function () {
            new Ajax.Request('/toolbox/get_pac_btns',
                    {
                        asynchronous:true,
                        evalScripts:true,
                        parameters:{
                            'ids':pacBtns.toString(),
                            'authenticity_token':'<%=form_authenticity_token%>'}
                    });
        });
    </script>
<% end %>